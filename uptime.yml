---
- name: Check uptime and Inventory g·ªëc, send Telegram notification
  hosts: all-linux
  gather_facts: no
  tasks:

    - name: Ki·ªÉm tra k·∫øt n·ªëi SSH
      wait_for:
        port: 22
        host: "{{ inventory_hostname }}"
        timeout: 5
      delegate_to: localhost
      register: ssh_status
      ignore_errors: yes

    - name: L·∫•y Uptime tr√™n Linux
      command: uptime
      register: uptime_result
      when: ssh_status is succeeded
      changed_when: false
      ignore_errors: yes

    - name: Debug Uptime Output
      debug:
        msg: "{{ uptime_result.stdout | default('Kh√¥ng l·∫•y ƒë∆∞·ª£c') }}"

    - name: X√°c ƒë·ªãnh Inventory g·ªëc ch√≠nh x√°c
      set_fact:
        root_inventory: >-
          {{
            groups.keys() 
            | difference(['all', 'ungrouped', 'linux', 'win', 'all-linux', 'all-win'])
            | select('search', '^[a-zA-Z0-9_-]+$') 
            | select('in', groups | dict2items | selectattr('value', 'contains', inventory_hostname) | map(attribute='key') | list)
            | list | first | default('unknown')
          }}

    - name: Debug Inventory g·ªëc
      debug:
        msg: "Inventory g·ªëc: {{ root_inventory }}"

    - name: T·∫°o n·ªôi dung th√¥ng b√°o Telegram
      set_fact:
        telegram_message: |
          üñ• *Host:* `{{ inventory_hostname }}`
          üìÇ *Inventory g·ªëc:* `{{ root_inventory }}`
          ‚è≥ *Uptime:* `{{ uptime_result.stdout | default('üî¥ Kh√¥ng l·∫•y ƒë∆∞·ª£c') }}`

    - name: G·ª≠i th√¥ng b√°o Telegram
      uri:
        url: "https://api.telegram.org/bot{{6725419910:AAFPnpMWsIU_kuGFw_RkdjQeyvhzZQ1qxPA}}/sendMessage"
        method: POST
        body_format: json
        body:
          chat_id: "{{-4132281180}}"
          text: "{{ telegram_message }}"
          parse_mode: "Markdown"
      when: uptime_result is defined
