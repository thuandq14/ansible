---
- name: Check uptime and Inventory g·ªëc, send Telegram notification
  hosts: all-linux
  gather_facts: no
  tasks:

    - name: Ki·ªÉm tra k·∫øt n·ªëi SSH
      wait_for:
        port: 22
        host: "{{ inventory_hostname }}"
        timeout: 5
      delegate_to: localhost
      register: ssh_status
      ignore_errors: yes

    - name: L·∫•y Uptime tr√™n Linux
      command: uptime
      register: uptime_result
      when: ssh_status is succeeded
      changed_when: false
      ignore_errors: yes

    - name: Debug Uptime Output
      debug:
        msg: "{{ uptime_result.stdout | default('Kh√¥ng l·∫•y ƒë∆∞·ª£c') }}"

    - name: X√°c ƒë·ªãnh Inventory g·ªëc
      set_fact:
        root_inventory: >-
          {{ groups.keys() | difference(['all', 'ungrouped', 'linux', 'win', 'all-linux', 'all-win'])
          | select('match', '^[a-zA-Z0-9_-]+$')
          | selectattr(inventory_hostname, 'in', groups)
          | list | first | default('unknown') }}

    - name: Debug Inventory g·ªëc
      debug:
        msg: "Inventory g·ªëc: {{ root_inventory }}"

    - name: T·∫°o n·ªôi dung th√¥ng b√°o Telegram
      set_fact:
        telegram_message: |
          üñ• *Host:* `{{ inventory_hostname }} ({{ ansible_default_ipv4.address | default('N/A') }})`
          üìÇ *Inventory g·ªëc:* `{{ root_inventory }}`
          ‚è≥ *Uptime:* `{{ uptime_result.stdout | default('üî¥ Kh√¥ng l·∫•y ƒë∆∞·ª£c') }}`

    - name: G·ª≠i th√¥ng b√°o Telegram
      uri:
        url: "https://api.telegram.org/bot{{ TELEGRAM_BOT_TOKEN }}/sendMessage"
        method: POST
        body_format: json
        body:
          chat_id: "{{ TELEGRAM_CHAT_ID }}"
          text: "{{ telegram_message }}"
          parse_mode: "Markdown"
      when: uptime_result is defined
