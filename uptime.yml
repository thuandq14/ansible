---
- name: Check uptime and group membership with Telegram notification
  hosts: all-linux
  gather_facts: no  # KhÃ´ng cáº§n thu tháº­p facts Ä‘áº§y Ä‘á»§, giÃºp cháº¡y nhanh hÆ¡n

  vars:
    telegram_bot_token: "6725419910:AAFPnpMWsIU_kuGFw_RkdjQeyvhzZQ1qxPA"  # Thay báº±ng token cá»§a báº¡n
    telegram_chat_id: "-4132281180"  # Thay báº±ng chat ID cá»§a báº¡n

  tasks:
    - name: Láº¥y uptime trÃªn Linux
      command: uptime
      register: linux_uptime
      ignore_errors: yes

    - name: XÃ¡c Ä‘á»‹nh Inventory gá»‘c chÃ­nh xÃ¡c
      set_fact:
        root_inventory: >-
          {{ groups.keys()
          | difference(['all', 'ungrouped', 'linux', 'win', 'all-linux', 'all-win'])
          | select('match', '^[a-zA-Z0-9_-]+$')  # Chá»‰ láº¥y tÃªn há»£p lá»‡
          | select('selectattr', '1', 'contains', inventory_hostname, groups)
          | list
          | first | default('unknown') }}

    - name: Hiá»ƒn thá»‹ thÃ´ng tin debug
      debug:
        msg: >-
          ğŸ–¥ Host: {{ inventory_hostname }} ({{ ansible_host }})
          ğŸ“‚ Inventory gá»‘c: {{ root_inventory }}

          â³ Uptime:
          {{ linux_uptime.stdout | default('KhÃ´ng láº¥y Ä‘Æ°á»£c') }}

    - name: Gá»­i thÃ´ng bÃ¡o Telegram
      uri:
        url: "https://api.telegram.org/bot{{ telegram_bot_token }}/sendMessage"
        method: POST
        body_format: json
        body:
          chat_id: "{{ telegram_chat_id }}"
          text: >-
            ğŸ–¥ Host: {{ inventory_hostname }} ({{ ansible_host }})
            ğŸ“‚ Inventory gá»‘c: {{ root_inventory }}

            â³ Uptime:
            {{ linux_uptime.stdout | default('KhÃ´ng láº¥y Ä‘Æ°á»£c') }}
        headers:
          Content-Type: "application/json"
      register: telegram_result
      failed_when: telegram_result.status != 200
      when: telegram_bot_token is defined and telegram_chat_id is defined
