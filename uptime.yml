---
- name: Check uptime and group membership with Telegram notification
  hosts: all-linux
  gather_facts: no  # Kh√¥ng c·∫ßn gather_facts gi√∫p ch·∫°y nhanh h∆°n

  vars:
    telegram_bot_token: "6725419910:AAFPnpMWsIU_kuGFw_RkdjQeyvhzZQ1qxPA"
    telegram_chat_id: "-4132281180"
    exclude_groups: ['all', 'ungrouped', 'linux', 'win', 'all-linux', 'all-win']

  tasks:
    - name: Debug danh s√°ch group c√≥ th·ªÉ c√≥ host n√†y
      debug:
        msg: "{{ item }}"
      loop: "{{ groups.keys() | difference(exclude_groups) }}"
      when: inventory_hostname in groups[item]

    - name: X√°c ƒë·ªãnh Inventory g·ªëc ch√≠nh x√°c
      set_fact:
        root_inventory: >-
          {{ groups.keys() | difference(exclude_groups)
          | select('match', '^[a-zA-Z0-9_-]+$')
          | select('extract', groups, inventory_hostname in groups[item])
          | list | first | default('unknown') }}

    - name: Debug Inventory g·ªëc
      debug:
        msg: "Inventory g·ªëc: {{ root_inventory }}"

    - name: L·∫•y uptime tr√™n Linux
      command: uptime
      register: linux_uptime
      ignore_errors: yes

    - name: G·ª≠i th√¥ng b√°o Telegram
      uri:
        url: "https://api.telegram.org/bot{{ telegram_bot_token }}/sendMessage"
        method: POST
        body_format: json
        body:
          chat_id: "{{ telegram_chat_id }}"
          text: |
            üñ• *Host:* `{{ inventory_hostname }} ({{ ansible_host }})`
            üìÇ *Inventory g·ªëc:* `{{ root_inventory }}`
            ‚è≥ *Uptime:* `{{ linux_uptime.stdout | default('Kh√¥ng l·∫•y ƒë∆∞·ª£c') }}`
        headers:
          Content-Type: "application/json"
        status_code: 200
      register: telegram_result
      failed_when: telegram_result.status != 200
      when: telegram_bot_token is defined and telegram_chat_id is defined
