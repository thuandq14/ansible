---
- name: X√°c ƒë·ªãnh Inventory g·ªëc v√† g·ª≠i Telegram
  hosts: all-linux
  gather_facts: no
  tasks:
    - name: X√°c ƒë·ªãnh Inventory g·ªëc ch√≠nh x√°c
      set_fact:
        inventory_goc: >-
          {{
            groups.keys()
            | difference(['all', 'ungrouped', 'linux', 'win', 'all-linux', 'all-win'])
            | select('search', '.*')
            | select('reject', 'match', '^(win|linux)$')  # B·ªè nh√≥m con
            | select('selectattr', '1', 'contains', inventory_hostname, groups)
            | map('first')
            | list
            | first
            | default('Unknown')
          }}

    - name: L·∫•y th√¥ng tin uptime
      command: uptime -p
      register: uptime_result
      changed_when: false

    - name: Debug ki·ªÉm tra nh√≥m th·ª±c s·ª±
      debug:
        msg: "Host {{ inventory_hostname }} thu·ªôc Inventory g·ªëc: {{ inventory_goc }}, Uptime: {{ uptime_result.stdout }}"

    - name: G·ª≠i th√¥ng b√°o Telegram
      uri:
        url: "https://api.telegram.org/bot<BOT_TOKEN>/sendMessage"
        method: POST
        body_format: json
        body:
          chat_id: "-4132281180"
          text: |
            üö® *TH√îNG B√ÅO INVENTORY* üö®
            üñ• Host: `{{ inventory_hostname }}`
            üè∑ Inventory g·ªëc: `{{ inventory_goc }}`
            ‚è≥ Uptime: `{{ uptime_result.stdout }}`
        headers:
          Content-Type: "application/json"
      when: inventory_goc != "Unknown"
