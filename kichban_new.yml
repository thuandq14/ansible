---
- name: Check uptime of remote server
  hosts: all
  gather_facts: no
  tasks:
    - name: Get Inventory gá»‘c
      set_fact:
        inventory_goc: "{{ group_names | intersect(groups.keys()) | first | default('Unknown') }}"

    - name: Run uptime command
      command: uptime
      register: uptime_result
      ignore_errors: yes

    - name: Ghi nháº­n host unreachable
      set_fact:
        unreachable_hosts: "{{ ansible_play_hosts_all | difference(ansible_play_hosts) }}"
      run_once: yes

    - name: Gá»­i cáº£nh bÃ¡o Telegram khi host unreachable
      uri:
        url: "https://api.telegram.org/bot<YOUR_BOT_TOKEN>/sendMessage"
        method: POST
        body_format: json
        body:
          chat_id: "-4132281180"
          text: |
            ğŸš¨ *Cáº¢NH BÃO HOST KHÃ”NG Káº¾T Ná»I* ğŸš¨
            âŒ Host khÃ´ng káº¿t ná»‘i: `{{ item }}`
            ğŸ· Inventory gá»‘c: `{{ hostvars[item].inventory_goc | default('Unknown') }}`
            ğŸ–¥ Há»‡ Ä‘iá»u hÃ nh: `{{ 'Windows' if 'win' in hostvars[item].group_names else 'Linux' }}`
          parse_mode: "Markdown"
        headers:
          Content-Type: "application/json"
      loop: "{{ unreachable_hosts }}"
      run_once: yes
      delegate_to: localhost

    - name: Gá»­i thÃ´ng bÃ¡o Telegram sau khi cháº¡y
      uri:
        url: "https://api.telegram.org/bot<YOUR_BOT_TOKEN>/sendMessage"
        method: POST
        body_format: json
        body:
          chat_id: "-4132281180"
          text: |
            ğŸ“ *Káº¾T QUáº¢ CHáº Y ANSIBLE* ğŸ“
            ğŸ”¹ Host: `{{ inventory_hostname }}`
            ğŸ· Inventory gá»‘c: `{{ inventory_goc }}`
            ğŸ–¥ Há»‡ Ä‘iá»u hÃ nh: `{{ 'Windows' if 'win' in group_names else 'Linux' }}`
            {% if uptime_result.rc is defined and uptime_result.rc == 0 %}
            âœ… *ThÃ nh cÃ´ng*: `{{ uptime_result.stdout }}`
            {% else %}
            âŒ *Lá»—i*: `{{ uptime_result.stderr if uptime_result.stderr else 'Unknown error' }}`
            {% endif %}
          parse_mode: "Markdown"
        headers:
          Content-Type: "application/json"
      delegate_to: localhost
